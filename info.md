# PAC2021 final -- ChiFanBuZhangRou

TODOs

- [x] Add rabbitio
- [x] Use other map
- [ ] Parallel in load map
- [ ] Use secondary index
- [x] Use list-hash
- [ ] Use aili-code ？？？
- [ ] Optimize match algorithm
- [ ] Use gcc7 / gcc11
- [x] Use icc
- [x] Add pugz
- [ ] Read se not pe
- [x] Use parallel zip when write
- [ ] Check todos 👇（//TODO）
- [x] Why write .fq.gz size diff ?
- [ ] Write fq in order?
- [x] queue1 more bigger (128x128 -> 128x1024)
- [ ] change block size in pugz(32kb -> 4mb)
- [x] change block size in pigz
- [ ] change queue1 to dataPool to decrease new and delete operations
- [ ] fix pigzWrite bug
- [ ] mod all barcode to 1e9, use it dirctely, cal time
- [ ] test G‘s map
- [ ] test 0 3 6 9
- [x] merge mip write part
- [ ] check👆
- [x] add bloom filter
- [ ] 

## 0908

淦之前写的info整不见了，麻了。

| version                                               | total  | hdf5  | others |      |      |
| ----------------------------------------------------- | ------ | ----- | ------ | ---- | ---- |
| init                                                  | ～1100 | ～100 | ～1000 |      |      |
| add rabbitio from rabbitqc                            | 750    | 100   | 650    |      |      |
| no gz                                                 | 386    | 100   | 286    |      |      |
| no gz && replace std::unordered_map to robin_hood::xx | 220    | 50    | 170    |      |      |
| no gz && use list hash                                | 179    | 28    | 151    |      |      |
| use list hash                                         | 500    | 29    | 191+x  |      |      |

//TODO 为了过编译把boost部分涉及到map的操作做了复制，还有析构的时候swap都注释掉了

## 0909

目前先搞搞消费者吧，先不整gz，让读和写线程不会是瓶颈。上面是简单把map换了，换前后都能拉起来64线程，说明消费者还有提升空间，今天准备试试链式hash，感觉思路和主办方给的二级索引应该差不多。

确实有点子提升，但是没有特别快，更新👆。

写的时候有点子小小的bug，基础不牢地动山摇啊，本来以为传指针进去就不用&了，但之前的用法都是修改指针指向的空间里面的信息，这可以不用&，但是今天属于是直接该指针的值了。

## 0910

好像听说并行文件系统每次写波动太大，开放了计算节点上的user目录，这里简单测测对我们有没有影响：

|                                                       |                 |
| ----------------------------------------------------- | --------------- |
| Use list hash                                         | 499+500+510+500 |
| no gz 👆                                               | 193+189+191     |
| no gz icpc  -Ofast -xHost -qopt-zmm-usage=high        | 192             |
| no gz g++  -Ofast -funroll-loops -flto  -march=native | 186+188         |
| gz   g++  -Ofast -funroll-loops -flto  -march=native  | 530+544         |

目前读写gz大约只能用起30个核心，比起之前的50个核心有了一定的提升。

简单换一个gcc版本和icpc试试，但是编译的时候报错了，初步猜测是编译好的hdf5和boost库是用的gcc4，相差太多不能用，用gcc7重新搞一份。

## 0911

没啥用啊，用gcc7编译的boost还是报错，并且找了个简单的例子，也还是报错，目前猜测就是gcc7和gcc11自己安装的时候少了什么步骤。现在的内存使用大约是list hash map就用了10.5G左右，然后后面整个消费者们在用3G左右，如果写gz的话会来不及压缩导致积压在内存里，能到20G以上。

简单换了一下编译器和编译参数，update👆。

多多少少有点用吧可能。

今天这机器不大行啊。

c，zz别开箱子了可。

## 0912

今天看了看pugz，具体原理emmm论文太长了属实是读不下去，改天去图书馆慢慢看吧。

稍微修改了代码，好像多线程现在就是流式处理的？？？把原来wite to stdout改成了to file，去shm下简单测了测性能，基本上8线程能到30s以下，非常不错符合赛题的要求，现在再测测直接把20G的玩意整到内存里看看咋样。

## 0913

感觉pugz也一定程度上可以流式处理，简单加到了决赛题里面

|                                      | Total |      |
| ------------------------------------ | ----- | ---- |
| add pugz (one thread), in gz, out fq | 187   |      |
| Submit4, in gz, out fq               | 216   |      |
|                                      |       |      |

单线程的话要比普通的解压缩好一点，但是并没有直接pugz单线程和gunzip那样明显，而且现在多线程会出现错误，即解压出来的两块大小虽然一样但是里面的回车不一样多。。。。

## 0914

giao

ConcurrentQueue不是有序的，麻了。换成了同一个人搞得ReaderWriterQueue，一对一，现在能过check了，简单测试一下：

|                           | insert | pugz1/pugz2/producer/consumer/total | run use number of consumer             |      |
| ------------------------- | ------ | ----------------------------------- | -------------------------------------- | ---- |
| init in gz out fq         | 24     | x/x/189/190/214                     | <30 ~28                                |      |
| pugz thread1 in gz out fq | 23     | 140/140/158/160/190                 | 不稳定，有时候能到30多，大部分时间50多 |      |
| pugz thread2 in gz out fq | 27     | 130/140/160/170/190                 | 👆                                      |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |
|                           |        |                                     |                                        |      |

感觉效果一般啊，而且运行他给的gz文件还老是出错。。。。自己重新压缩了两个gz（一个要半小时，，，，淦）

|                               | pugz1/pugz2/producer/consumer/total |      |
| ----------------------------- | ----------------------------------- | ---- |
| no process gz in no out，init | x/x/185/190/210                     |      |
| 👆，pugz thread 1              | 46/50/46/50/75                      |      |
| 👆，pugz thread 2              | 35/37/35/37/62                      |      |
| 👆，pugz thread 4              | 30/33/52/53/78                      |      |
| 👆，pugz thread 8              | 31/30/56/59/84                      |      |

虽然两个线程最好有点子奇怪，但是基本上时间还比较合理，但是不加no process的话要跑100+s，不太合理。

## 0915

|                                   |      |            | producer   | consumer | total |
| --------------------------------- | ---- | ---------- | ---------- | -------- | ----- |
| in gz，out fq                     | 12G  | ～3500%    | 187        | 190      | 214   |
| pugz thread2👆                     | 35G  | >6000%     | 153(100)   | 160      | 190   |
| pugz thread4👆                     | x    | 不稳定。。 | x          | x        | x     |
| dataPool 1024,dataQueue 2048 init | 13G  | ～3000%    | 189        | 190      | 218   |
| pugz thread2👆                     | 30G  | 不稳定     | 150        | 180      | 204   |
| in fq，out fq                     | 17G  | ～6400%    | 144        | 160      | 188   |
| real data init                    | 12G  | ～3500%    | 189        | 190      | 218   |
| real data 128/500 pugz thread2    | <30G | ～6000%    | 157（120） | 160      | 190   |
|                                   |      |            |            |          |       |

把dataPool和dataQueue弄大了也没啥用。

表里面的生产者时间其实也没有太大的参考价值，因为可能消费者太慢把dataQueue堵住了，生产者在等待；可以发现init读gz的时候P和C的时间基本一样，这里应该是C在等P，P搞出来最后一块数据C处理完就都结束了，而读fq或者pugz的话P和C的时间有一点差距，应该是C太慢，queue满了，P中间等待了，最后P搞完队列里还有些数据，然后C处理完。



## 0916

最近今天属于是脑子不太清醒，整不明白为啥消费者多用了接近一倍但是时间没咋变？

今天先赶赶进度，把bgzip加上，要不压缩太慢了，昨天在fat上试了试，bgzip压缩出来的gz文件gunzip是可以读的，但是pugz不支持。

下面测试一下，输出到/dev/shm

| Unzip           | p1.fq |      |
| --------------- | ----- | ---- |
| unpigz thread 1 | 83    |      |
| unpigz thread 2 | 66    |      |
| unpigz thread 4 | 66    |      |
| unpigz thread 8 | 66    |      |
| pugz thread 1   | 59    |      |
| pugz thread 2   | 40    |      |
| pugz thread 4   | 27    |      |
| gunzip          | 150   |      |

| Zip               | p1.fq  |      |
| ----------------- | ------ | ---- |
| pigz thread 1     | >1800  |      |
| pigz thread 2     | ～1000 |      |
| pigz thread 4     | ～500  |      |
| pigz thread 8     | ～250  |      |
| gzip              | ~1800  |      |
| bgzip thread 1 -1 | 400    |      |
| bgzip thread 2 -1 | 200    |      |
| bgzip thread 4 -1 | 100    |      |
| bgzip thread 8 -1 | 52     |      |
|                   |        |      |
|                   |        |      |
| pigz thread 1 -4  | 420    |      |
| pigz thread 2 -4  | 210    |      |
| pigz thread 4 -4  | 105    |      |
| pigz thread 8 -4  | 53     |      |
| gzip -4           | 450～  |      |
| bgzip thread 1 -4 | 240    |      |
| bgzip thread 2 -4 | 120    |      |
| bgzip thread 4 -4 | 60     |      |
| bgzip thread 8 -4 | 32     |      |
|                   |        |      |
|                   |        |      |

有点奇怪为啥代码里面的gzwrite压缩起来那么快？

## 0917

淦，代码里面是-4，只就用gzip或者pigz -4也很快，而且简单测试之后发现pigz的线程加速比还是挺好的；而bgzip作为分块压缩似乎比pigz效果更好，但是pugz没法处理bgzip压缩出来的gz文件，pugz可以用两个线程处理pigz压缩出来的文件（//TODO 线程数多的时候可能会报错）。

综上，综合考虑速度可易用性，准备使用pugz进行多线程的解压缩（这个可以正常处理gzip压缩出来的文件，也可以两个线程//TODO处理pigz压缩出来的文件，但是无法处理bgzip压缩出来的文件---只会解压第一块），然后使用pigz进行压缩（这样压缩出来的文件到下一个流程使用普通的gunzip完全可以，使用我们自己的代码开两个线程读也是可以的）。

## 0918

解封了芜湖

|                             |      |         |            |      |      |
| --------------------------- | ---- | ------- | ---------- | ---- | ---- |
| in gz                       | 12G  | ～3500% | 189        | 190  | 218  |
| in gz，pugz thread 2        | <30G | ～6000% | 157（120） | 160  | 190  |
| /users in gz                | 12G  | ～3500% | 190        | 190  | 219  |
| /users in gz，pugz thread 2 | <30G | ～6000% | 157（120） | 160  | 190  |
| /users in gz，pugz thread 1 | <30G | >6000%  | 151（120） | 160  | 183  |
| /users in fq                |      |         |            |      |      |

给pugz和producer之间的queue加个大小限制吧。

淦 好像死锁了。。。。

## 0919

未曾设想过的错误，，，，sleep单位居然是s，我怎么记得之前用的都是ms啊。。。然后队列1满了的时候pugz线程就开始了长达1000s的沉睡。。。。

改成usleep之后有加了个producer结束的tag，如果producer结束了pugz线程就停止解压了。

|                                             |      |                  |                 |      |      |
| ------------------------------------------- | ---- | ---------------- | --------------- | ---- | ---- |
| in gz，pugz thread 2，queue 128*128         | <18G | ～6000%          | 157（150，157） | 160  | 192  |
| in gz，pugz thread 1，queue 128*128         | <18G | ～6000%          | 157（150，157） | 160  | 192  |
| get map and pugz same time thread 1         | <18G | >6000%           | 180 180 180     | 180  | 187  |
| get map and pugz same time thread 1         | <18G | >6000%           | 180 180 190     | 190  | 197  |
| queue1：1<<20，in gz，out gz，pugz thread 1 | ~60G | 6400->5000->6400 | 186 89 94       | 189  | 191  |

发现开始的几秒似乎线程都用不起来，应该是P在等pugz，这块时间可以先简单的和hashmap insert放到一块，反正互不影响。

//TODO 把queue1开的大一点方便一开始掩盖pugz的时候能预处理出更多的块。

//TODO 修改pugz每一块的大小

//TODO 给queue1改成一个内存池，减少new和delete

好啊，基本上生产者们搞得大体差不多了（P和pugz），现在搞一下write。

|                                             |      |              |             |      |      |
| ------------------------------------------- | ---- | ------------ | ----------- | ---- | ---- |
| 👆 pugz thread 1，in gz，out gz              | 30G  | 4000%～5000% | 204 200 210 | 210  | 566  |
| 👆 pugz thread 2，in gz，out gz              | 30G  | 4000%～5000% | 204 200 210 | 210  | 566  |
| queue1：1<<20，in gz，out gz，pugz thread 1 | <60G | ～5000%      | 197 90 90   | 198  | 530  |
| queue1：1<<20，in gz，out gz，pugz thread 2 | <60G | ～6000%      | 194 57 62   | 195  | 538  |
|                                             |      |              |             |      |      |
|                                             |      |              |             |      |      |

## 0920

简单看了看pigz的文档，没有api但是stack overflow里面有一个pigz的开发者回答的问题，说是要支持pipe，看更新日志大约回答这个问题两个月之后pigz真的加了这块功能，但是稍微看了看参数没找到咋用。。。还是直接改代码吧。

把pigz加到决赛的代码里（直接把pigz.c复制到multi.cpp里面的，很丑陋。。。。然后改了yarn.h中的关键字，然后把.h文件都加了extren C，把comliain(x,...)给注释了，勉强可以运行了）

现在简单测试一下，先用原来的write把fq写到硬盘上，再用开个线程用pigz压缩。

|                                                   |               |               |           |         |      |
| ------------------------------------------------- | ------------- | ------------- | --------- | ------- | ---- |
| add pigz thread 2，in gz，out gz，pugz thread 1👆  | <60G          | ～5000%/6400% | 193 90 95 | 196+242 | 443  |
| add pigz thread 16，in gz，out gz，pugz thread 1👆 | <60G          | ～6000%/6400% | 191 90 95 | 195+47  | 244  |
| add pigz thread 32，in gz，out gz，pugz thread 2👆 | <60G（～50G） | ～6000%/6400% | 191 55 59 | 195+39  | 238  |
| add pigz thread 64，in gz，out gz，pugz thread 2👆 | <60G（～50G） | ～6000%/6400% | 184 55 59 | 188+30  | 219  |

## 0921 

```
rm -rf combine_read.fq && rm -rf combine_read.fq.gz && ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 V300091300_L03_read_1.fq.gz  --in2 V300091300_L04_read_1.fq.gz --out combine_read.fq --mismatch 2 --thread 64 --usePugz --pugzThread 2 --usePigz --pigzThread 32
```

```c++
		int th_num = mOptions->pigzThread;
    printf("th num is %d\n", th_num);
    string th_num_s = to_string(th_num);
    printf("th num s is %s\n", th_num_s.c_str());
    printf("th num s len is %d\n", th_num_s.length());

    infos[2] = new char[th_num_s.length() + 1];
    memcpy(infos[2], th_num_s.c_str(), th_num_s.length());
```

这段代码好像emmm，char*后面找不到结束符，用的时候就可能出问题，现在的策略是再加一句

```c++
infos[2][th_num_s.length()] = '\0';
```

感觉不太优雅。

update table 👆

## 0922

原来的pigz代码里包括了输入文件xx.fq是否存在的检查，现在只能是把out参数的xx.fq.gz改成xx.fq，用源代码writer的new ofstream生成一个空的xx.fq欺骗一下pigz（5000行代码是在不想动）。

然后现在在writer和pigz之间加了一个queue，大小还是1<<20，把pigz的块大小改成了4M。

|                                             |      |               | producer(pugz) | comsumer(pigz) | total |
| ------------------------------------------- | ---- | ------------- | -------------- | -------------- | ----- |
| no more disk write and read，pugz 2，pigz 4 | ~60G | ～5000%/6400% | 195 61 66      | 198 201        | 201   |
| no more disk write and read，pugz 2，pigz 2 | ~60G | ～5000%/6400% | 193 62 67      | 194 283        | 294   |
| no more disk write and read，pugz 1，pigz 4 | ~60G | ～5000%/6400% | 183 95 100     | 187 189        | 190   |
| 👆pigz block size 8M，pugz 1，pigz 4         | ~60G | ～5000%/6400% |                |                | 203   |

这个测得时间有点子波动。。。算了先不管了，反正大体上，单独测试的话压缩和解压缩大约30s左右，在程序里测试的话压缩大约60s，解压缩16个线程也能60s以内，但是现在消费者耗时远高于60s，可以先把重点转移到消费者上了。

简单分析了现在的hash map，一共2.6e8个元素，mod是1e9+7，有2e8个是不冲突的，所以mod取这么大的情况下并不需要在链表这里做什么操作。但是同样的，内存需求也是很大的，直接的hash表大约占3G，后面链表存储的2.6e8个int64大约占4G。

换几个mod试试：（简单的读fq写fq）

|            |       |       | get map |         |      |
| ---------- | ----- | ----- | ------- | ------- | ---- |
| 1e9+7      | ～12G | 6400% | 27      | 169 174 | 175  |
| 73939133   | ～10G | 6400% | 40      | 512 529 | 529  |
| 1073807359 | ～13G | 6400% | 26      | 165 169 | 170  |
| 2000000011 | ～17G | 6400% | 30      | 171 176 | 176  |
|            |       |       |         |         |      |

好啊，没啥用感觉，毕竟1e9+7的时候就有80%左右的元素hash是没有冲突的，然后10%只冲突一次，以此类推。

然后做getPosition之前其实可以根据原来代码的逻辑先对umi做一下filter，如果没有通过那么getPosition也可以直接不做了。淦他要统计mMapToSlideRead这变量，，，，所以这种方式不能用。。。。。。GG

|                                             |      |               | producer(pugz) | comsumer(pigz) | total |
| ------------------------------------------- | ---- | ------------- | -------------- | -------------- | ----- |
| no more disk write and read，pugz 1，pigz 4 | ~60G | ～5000%/6400% | 183 95 100     | 187 189        | 190   |
| 👆 use 1073807359                            | ~60G | ～5000%/6400% | 180 85 91      | 183 183        | 185   |
|                                             |      |               |                |                |       |
|                                             |      |               |                |                |       |
|                                             |      |               |                |                |       |

//TODO 把barcode缩一下范围直接搞个数组来测测跑多久。

晚上跑完步突然听到大师兄问线程加速比咋样，emmm好问题。

简单测测

|                          |      |        | getmap/producer | comsumer | total |
| ------------------------ | ---- | ------ | --------------- | -------- | ----- |
| in fq，out fq，thread 64 | 14G  | 6400%  | 26/165          | 170      | 170   |
| in fq，out fq，thread 32 | 13G  | 3200%+ | 29/201          | 206      | 200   |
| in fq，out fq，thread 16 | 12G  | 1600%+ | 26/315          | 323      | 324   |
| in fq，out fq，thread 8  | 11G  | 800%+  | 26/582          | 597      | 590   |
| in fq，out fq，thread 4  | 11G  | 400%+  | 26/1146         | 1175     | 1150  |
| in fq，out fq，thread 2  |      |        | 30/2323         | 2384     | 2384  |
| in fq，out fq，thread 1  |      |        | 29/4046         | 4149     | 4149  |

按照之前qc使用c++ thread库实现P-C模型的经验来看，一般只要cpu跑起来了两倍的线程，速度就是两倍，但现在线程加速比不够好，初步猜测是伪共享或者remote numa访存效率低的原因，对于numa架构简单学习了一下：

https://zhuanlan.zhihu.com/p/62795773

简单说就是提高访问内存的效率，⬆️文中提到了内存需求很大，超过一个numa节点对应内存的时候频繁swap带来问题，现在代码里面的情况应该略有不同，是两个numa节点的core都用起来了，但是存储关键信息的hashmap只在某个节点的内存上，这样有一半core在访存的时候会比较慢。简单想到的解决办法就是在另个numa节点对应的内存里开一个hashmap的副本，那个节点访问自己的map。

编译了个软件看了看compute006的numa架构：

![server](/Users/ylf9811/Downloads/server.png)

## 0922

把postion换一下

## 0923

没换完，测一下no out，in fq，only socket0

|           | getmap | producer/comsumer      | total |      |
| --------- | ------ | ---------------------- | ----- | ---- |
| thread 32 | 30     | 187/192-30=157/162     | 192   |      |
| thread 16 | 27     | 275/282-27=248/255     | 282   |      |
| thread 8  | 26     | 490/503-26=464/477     | 503   |      |
| thread 4  | 26     | 942/966-26=916/940     | 966   |      |
| thread 2  | 27     | 1841/1889-27=1814/1862 | 1889  |      |
| thread 1  | 27     | 3648/3742-27=3621/3715 | 3742  |      |



|           | getmap | producer/comsumer      | total |      |
| --------- | ------ | ---------------------- | ----- | ---- |
| thread 32 | 27     | 196/201-27=169/174     | 201   |      |
| thread 16 | 27     | 313/321-27=286/294     | 321   |      |
| thread 8  | 27     | 567/582-27=540/555     | 582   |      |
| thread 4  | 27     | 1092/1120-27=1065/1093 | 1120  |      |
| thread 2  | 31     | 2384/2449-31=2353/2418 | 2449  |      |
| thread 1  |        |                        |       |      |



烦哦，这运行怎么忽快忽慢的。

pac

|                                     | get map | producer | consumer | total | time |
| ----------------------------------- | ------- | -------- | -------- | ----- | ---- |
| ./yrun.sh 64                        | 27      | 144      | 149      | 177   | 3m8  |
|                                     | 27      | 148      | 153      | 180   | 3m9  |
|                                     | 26      | 144      | 150      | 178   | 3m6  |
|                                     | 27      | 144      | 148      | 176   | 3m4  |
| ./yrun.sh 64 remove Positon         | 28      | 140      | 145      | 175   | 3m4  |
|                                     | 27      | 151      | 156      | 184   | 3m10 |
|                                     | 27      | 141      | 145      | 173   | 3m0  |
|                                     | 29      | 152      | 157      | 187   | 3m16 |
|                                     |         |          |          |       |      |
| ./yrun.sh 32                        | 26      | 171      | 177      | 203   | 3m28 |
|                                     | 27      | 169      | 174      | 201   | 3m29 |
|                                     | 27      | 171      | 176      | 204   | 3m32 |
|                                     | 26      | 173      | 178      | 207   | 3m29 |
|                                     |         |          |          |       |      |
| ./yrun.sh 32 remove Positon         | 21      | 152      | 157      | 178   |      |
|                                     | 21      | 153      | 158      | 180   |      |
|                                     | 21      | 150      | 155      | 176   |      |
|                                     | 21      | 151      | 155      | 177   |      |
|                                     | 21      | 153      | 158      | 179   |      |
|                                     | 21      | 143      | 148      | 169   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 32 remove Positon socket0 | 22      | 144      | 149      | 171   |      |
|                                     | 22      | 143      | 148      | 170   |      |
|                                     | 21      | 144      | 160      | 182   |      |
|                                     | 22      | 144      | 148      | 170   |      |
|                                     | 21      | 144      | 148      | 169   |      |
|                                     | 21      | 144      | 148      | 170   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 16                        | 26      | 293      | 301      | 329   | 5m30 |
|                                     | 28      | 287      | 295      | 327   | 5m28 |
|                                     | 28      | 288      | 296      | 324   | 5m27 |
|                                     | 26      | 288      | 296      | 323   | 5m28 |
|                                     |         |          |          |       |      |
| ./yrun.sh 16 remove Positon         |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| /yrun.sh 16 remove Positon socket0  | 21      | 223      | 229      | 251   |      |
|                                     | 21      | 223      | 230      | 252   |      |
|                                     | 21      | 223      | 229      | 251   |      |
|                                     | 22      | 223      | 229      | 251   |      |
|                                     | 21      | 223      | 229      | 250   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 8 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 8 remove Positon socket0  | 22      | 395      | 406      | 428   |      |
|                                     | 21      | 394      | 405      | 427   |      |
|                                     | 21      | 394      | 405      | 426   |      |
|                                     | 22      | 394      | 405      | 427   |      |
|                                     | 21      | 394      | 404      | 427   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 4 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 4 remove Positon socket0  | 21      | 748      | 768      | 790   |      |
|                                     | 21      | 752      | 772      | 794   |      |
|                                     | 21      | 747      | 767      | 789   |      |
|                                     | 21      | 750      | 770      | 792   |      |
|                                     | 21      | 751      | 770      | 792   |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 2 remove Positon          |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
|                                     |         |          |          |       |      |
| ./yrun.sh 2 remove Positon socket0  | 21      | 1463     | 1502     | 1523  |      |
|                                     | 22      | 1466     | 1504     | 1526  |      |
|                                     |         |          |          |       |      |

fat

|              | get map | producer | consumer | total | time  |
| ------------ | ------- | -------- | -------- | ----- | ----- |
| ./yrun.sh 40 | 40      | 174      | 180      | 220   | 3m40s |
|              | 34      | 169      | 175      | 210   | 3m31  |
|              | 35      | 169      | 174      | 209   | 3m29  |
|              | 33      | 170      | 176      | 209   | 3m30  |
|              |         |          |          | 210   |       |
|              |         |          |          | 214   |       |
|              |         |          |          |       |       |
| ./yrun.sh 20 | 34      | 317      | 327      | 363   | 6m2   |
|              | 34      | 314      | 323      | 357   | 5m58  |
|              | 36      | 319      | 329      | 366   | 6m6   |
|              | 35      | 322      | 331      | 367   | 6m7   |
|              | 34      | 298      | 307      | 341   | 5m42  |
|              | 33      | 306      | 315      | 349   | 5m49  |
|              |         |          |          | 352   |       |
| ./yrun.sh 10 |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |
|              |         |          |          |       |       |

```
rm -rf combine_read.fq && sleep 10 && time ../ST_BarcodeMap-0.0.1 --in DP8400016231TR_D1.barcodeToPos.h5 --in1 p1.fq --in2 p2.fq --out combine_read.fq --mismatch 2 --thread 32
```

## 0924 0925

一直在做测试

发现了惊天大秘密，006和003运行的不一样快，003要快一些。

|                                     | get map | producer | consumer | total | time         |
| ----------------------------------- | ------- | -------- | -------- | ----- | ------------ |
| ./yrun.sh 64 remove Positon         | 21      | 145      | 150      | 171   |              |
|                                     | 22      | 128      | 133      | 155   |              |
|                                     | 21      | 142      | 147      | 169   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 32 remove Positon         | 21      | 152      | 157      | 178   |              |
|                                     | 21      | 153      | 158      | 180   |              |
|                                     | 21      | 150      | 155      | 176   |              |
|                                     | 21      | 151      | 155      | 177   |              |
|                                     | 21      | 153      | 158      | 179   |              |
|                                     | 21      | 158      | 163      | 184   |              |
|                                     | 22      | 155      | 159      | 182   |              |
|                                     | 21      | 157      | 162      | 184   |              |
|                                     | 21      | 151      | 156      | 177   |              |
|                                     | 21      | 152      | 165      | 187   | 180*1.5=270  |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 32 remove Positon socket0 | 22      | 144      | 149      | 171   |              |
|                                     | 22      | 143      | 148      | 170   |              |
|                                     | 21      | 144      | 160      | 182   |              |
|                                     | 22      | 144      | 148      | 170   |              |
|                                     | 21      | 144      | 148      | 169   |              |
|                                     | 21      | 144      | 148      | 170   |              |
|                                     | 21      | 143      | 148      | 169   |              |
|                                     | 21      | 144      | 148      | 171   |              |
|                                     | 21      | 143      | 148      | 170   |              |
|                                     | 21      | 144      | 148      | 178   |              |
|                                     | 21      | 144      | 148      | 170   |              |
|                                     | 21      | 143      | 148      | 170   | 170*1.47=250 |
|                                     |         |          |          |       |              |
| ./yrun.sh 16 remove Positon         | 22      | 242      | 249      | 271   |              |
|                                     | 21      | 241      | 248      | 270   |              |
|                                     | 21      | 243      | 250      | 271   |              |
|                                     | 21      | 242      | 249      | 271   |              |
|                                     | 21      | 243      | 249      | 271   | 270*1.81=490 |
|                                     |         |          |          |       |              |
| /yrun.sh 16 remove Positon socket0  | 21      | 223      | 229      | 251   |              |
|                                     | 21      | 223      | 230      | 252   |              |
|                                     | 21      | 223      | 229      | 251   |              |
|                                     | 22      | 223      | 229      | 251   |              |
|                                     | 21      | 223      | 229      | 250   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 251   |              |
|                                     | 21      | 223      | 230      | 256   |              |
|                                     | 21      | 223      | 230      | 252   | 252*1.69=427 |
|                                     |         |          |          |       |              |
| ./yrun.sh 8 remove Positon          | 22      | 453      | 465      | 488   |              |
|                                     | 21      | 456      | 469      | 490   |              |
|                                     | 21      | 456      | 468      | 490   |              |
|                                     | 21      | 456      | 468      | 490   |              |
|                                     | 21      | 454      | 466      | 487   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 8 remove Positon socket0  | 22      | 395      | 406      | 428   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     | 22      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 404      | 427   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 427   |              |
|                                     | 21      | 395      | 405      | 427   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     | 21      | 394      | 405      | 426   |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 4 remove Positon          | 21      | 884      | 907      | 929   |              |
|                                     | 21      | 886      | 910      | 932   |              |
|                                     | 21      | 889      | 913      | 935   |              |
|                                     | 21      | 884      | 908      | 930   |              |
|                                     | 21      | 886      | 910      | 932   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 4 remove Positon socket0  | 21      | 748      | 768      | 790   |              |
|                                     | 21      | 752      | 772      | 794   |              |
|                                     | 21      | 747      | 767      | 789   |              |
|                                     | 21      | 750      | 770      | 792   |              |
|                                     | 21      | 751      | 770      | 792   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     | 21      | 750      | 770      | 792   |              |
|                                     | 21      | 750      | 770      | 791   |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 2 remove Positon          | 21      | 1758     | 1804     | 1825  |              |
|                                     | 21      | 1756     | 1802     | 1824  |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 2 remove Positon socket0  | 21      | 1463     | 1502     | 1523  |              |
|                                     | 22      | 1466     | 1504     | 1526  |              |
|                                     | 21      | 1467     | 1505     | 1527  |              |
|                                     | 21      | 1459     | 1497     | 1518  |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 1 remove Positon          | 21      | 3033     | 3109     | 3131  |              |
|                                     |         |          |          |       |              |
| ./yrun.sh 1 remove Positon socket0  | 21      | 2887     | 2962     | 2984  |              |
|                                     |         |          |          |       |              |

## 0926

update 👆

经过简单的测试，指定单个numa节点效果要好一点，003比006要好一点，用Position还是int32，区别不大，暂时都用int32的版本。

好啊，经过简单的测试，虽然大师兄说的线程加速比没有看出什么猫腻来，但是确实单个numa节点要好一些，现在搞一个版本，每个numa节点有自己的map副本，这样就不存在远程numa访问的问题了。

简单试试，就是同时跑两个程序，每次32个线程，跑在不同的numa节点上；具体的，两个程序传一个参数--socketId，0或者1，然后生产者只把对应的块读进来放到队列里面交给消费者处理，写就暂时分别写两个文件。

|                                                | get map | producer                | consumer                      | total   | time |
| ---------------------------------------------- | ------- | ----------------------- | ----------------------------- | ------- | ---- |
| socket0 32 half data                           | 21      | 71                      | 75                            | 97      |      |
|                                                | 21      | 71                      | 75                            | 97      |      |
|                                                | 21      | 71                      | 75                            | 97      |      |
| socket1 32 half data                           | 21      | 70                      | 74                            | 96      |      |
|                                                |         |                         |                               |         |      |
|                                                |         |                         |                               |         |      |
| merge 👆                                        | 21/21   | 71/71                   | 75/75                         | 97/96   |      |
|                                                |         |                         |                               |         |      |
|                                                |         |                         |                               |         |      |
| in gz，out gz thread 64-1-4                    | 22      | 136 93/99               | 138/147                       | 169     |      |
|                                                |         |                         |                               |         |      |
| in gz，out gz thread 32-1-4  socket0 half data | 21      | 87 62/67                | 87/87                         | 109     |      |
|                                                |         |                         |                               |         |      |
| in gz，out gz thread 32-1-4  socket1 half data | 21      | 87 62/67                | 87/87                         | 109     |      |
|                                                |         |                         |                               |         |      |
| mpirun -n 1, in fq, out fq, thread 64          | 22      | 147                     | 152                           | 183     |      |
|                                                | 22      | 137                     | 142                           | 164     |      |
|                                                | 21      | 139                     | 144                           | 171     |      |
| mpirun -n 2, in fq, out fq, thread 32          | 22/22   | 68/68                   | 72/72(write:72/87)            | 95/110  |      |
|                                                | 22/22   | 68/68                   | 72/72(write:72/73)            | 94/95   |      |
| mpirun -n 2, in gz, out gz, thread 32          | 22/22   | 79/79(pugz:79/79 83/83) | 82/83(write:82/83 pigz:84/84) | 107/107 |      |
|                                                |         |                         |                               | 107/107 |      |
|                                                |         |                         |                               | 109/109 |      |
|                                                |         |                         |                               |         |      |

## 0928

试了试快速mod，没什么用，晚上尝试加布隆过滤器。

|                     | get map/bloom | producer | consumer | total |
| ------------------- | ------------- | -------- | -------- | ----- |
| thread 64，no mpi， | 26            | 143      | 148      | 175   |
|                     | 26            | 139      | 143      | 169   |
|                     | 25            | 142      | 146      | 173   |
| thread 64，4 hash   | 35            | 194      | 201      | 237   |
| thread 64，1 hash   | 30            |          |          | 193   |

```
1 hash
total_query_cnt:	156371927497
after_filter_query_cnt:	144998762505

4 hash
total_query_cnt:	156371927497
after_filter_query_cnt:	156099493240

total_query_cnt:	156377424777
after_filter_query_cnt:	2431340523
find_query_cnt:	145470356

new wang hash
total_query_cnt:	156377424777
after_filter_query_cnt:	917789027
find_query_cnt:	145470356

```

## 0930

好啊，今天必须要出点活了，现在的情况是简单试了bloomfilter，确实能把99%的查询的筛掉，但是用了三个hash函数，并且是stl的bitset作为数据结构可能都不太高效，准备替换成手写试试。

此外，为了更好的评价每个版本的性能指标，需要对各个模块计时，目前的策略是把原来逻辑里面的break都干掉，然后通过注释bloomfilter的代码来评价时间。

好啊，现在把misoverlap部分的break注释，测测时间和查询次数：

```
no misoverlap break
total_query_cnt:        157473409122
after_filter_query_cnt: 1010068985
find_query_cnt: 233394250


```

这样测没啥用啊感觉，主要还是测bf占多少时间，改改策略，一个版本不做bf，另一个做bf但是不用他的结果。

```
做bf：
42+197


不做bf：
41+78

```



好啊，现在手写一个bloomfilter，用uint64*来作为数据结构存储，因为很多hash函数都是uint64        -> uint32之类的，所以存储的话bit数大约是1<<32，也就是1<<26这么大的uint64数组，然后查询key的时候要对应转化为。。。

试过了没啥用。

确实能过滤很多很多，但是并没有快，甚至慢了10s（110--120）

然后试了试把原来的hashmap换一种hash方式，没啥用；试了试直接把hash数组开大4倍，没啥用。

然后试试二级索引、内存小一点的bf、挑0，3，6，9。。。位做筛选、

## 1003

01 02放假摸鱼。

垂死病中惊坐起，没有用最新的rabbitio，用的是rabbitqc中的，果然自己挖的坑。。。。

|                  | getmap | tot  | tot-getmap |
| ---------------- | ------ | ---- | ---------- |
| no process，32*2 | 28     | 45   | 17         |
| no process，64*1 | 28     | 61   | 33         |
| no process，32*1 | 28     | 67   | 39         |
| ReRabbitQC，48   | /      |      | 31         |
| RabbitQC，48     |        |      | 31         |
| no process，32*2 | 21     | 64   | 42         |

嘶，测了测感觉多的拷贝也没啥影响啊。先写写mpi合并输出的版本吧。

## 1004

👆说的版本，改之前时间大约24/28-111、25/28-109

改之后size不太对emmm，时间大约25/28-116、25/28-118、24/27-118

淦，他size又对了？？上午上课的时候痴呆了？还是错误浮现不出来了？

//TODO//TODO//TODO//TODO//TODO

用rabbitqc看一看输出的结果，

STD：<img src="/Users/ylf9811/Library/Application Support/typora-user-images/image-20211004190937957.png" alt="image-20211004190937957" style="zoom:50%;" />

now：<img src="/Users/ylf9811/Library/Application Support/typora-user-images/image-20211004191001061.png" alt="image-20211004191001061" style="zoom:50%;" />

好像真的复现不出来了。。。。。
